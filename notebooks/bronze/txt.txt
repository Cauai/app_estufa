{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "818a9b89",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n",
      "[notice] A new release of pip is available: 25.2 -> 25.3\n",
      "[notice] To update, run: python.exe -m pip install --upgrade pip\n",
      "\n",
      "[notice] A new release of pip is available: 25.2 -> 25.3\n",
      "[notice] To update, run: python.exe -m pip install --upgrade pip\n"
     ]
    }
   ],
   "source": [
    "!pip install pdfplumber pandas --quiet\n",
    "!pip install pdfplumber pandas sqlalchemy psycopg2-binary python-dotenv --quiet\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "dbf1b478",
   "metadata": {},
   "outputs": [],
   "source": [
    "import re\n",
    "from pathlib import Path\n",
    "\n",
    "import pandas as pd\n",
    "import pdfplumber\n",
    "\n",
    "from sqlalchemy import create_engine, text\n",
    "from dotenv import load_dotenv\n",
    "import os"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "234b6500",
   "metadata": {},
   "outputs": [],
   "source": [
    "def extract_year_week_from_filename(file_path: str):\n",
    "    \"\"\"\n",
    "    Extrai ano e semana a partir do padr√£o ES2548:\n",
    "    ES2548 -> 25 = ano (2025), 48 = semana do invent√°rio\n",
    "    \"\"\"\n",
    "    name = Path(file_path).stem\n",
    "    m = re.search(r\"ES(\\d{2})(\\d{2})\", name)\n",
    "    if not m:\n",
    "        return None, None\n",
    "\n",
    "    ano_codigo = int(m.group(1))\n",
    "    semana_codigo = int(m.group(2))\n",
    "\n",
    "    ano = 2000 + ano_codigo\n",
    "    semana = semana_codigo\n",
    "    return ano, semana\n",
    "\n",
    "\n",
    "def ler_tabela_estufas(file_path: str) -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Procura, em todas as p√°ginas do PDF, a tabela cujo cabe√ßalho\n",
    "    cont√©m 'Bloco' E '√Årea Total' (ou 'Area Total').\n",
    "    S√≥ essa tabela √© considerada o invent√°rio principal.\n",
    "    \"\"\"\n",
    "    with pdfplumber.open(file_path) as pdf:\n",
    "        for page in pdf.pages:\n",
    "            tables = page.extract_tables()\n",
    "            for t in tables:\n",
    "                df_raw = pd.DataFrame(t)\n",
    "\n",
    "                # percorre as linhas procurando o cabe√ßalho\n",
    "                for i in range(len(df_raw)):\n",
    "                    row = df_raw.iloc[i].astype(str).str.strip()\n",
    "                    values = set(row.values)\n",
    "\n",
    "                    tem_bloco = any(v.lower() == \"bloco\" for v in values)\n",
    "                    tem_area_total = any(\n",
    "                        v.lower() in (\"√°rea total\", \"area total\") for v in values\n",
    "                    )\n",
    "\n",
    "                    if tem_bloco and tem_area_total:\n",
    "                        # essa √© a linha de cabe√ßalho\n",
    "                        header = row.tolist()\n",
    "                        df_data = df_raw.iloc[i + 1 :].reset_index(drop=True)\n",
    "                        df_data.columns = header\n",
    "                        return df_data\n",
    "\n",
    "    print(f\"Tabela de invent√°rio (com √Årea Total) n√£o encontrada em {file_path}\")\n",
    "    return pd.DataFrame()\n",
    "\n",
    "\n",
    "def limpar_e_transformar(df: pd.DataFrame, ano: int, semana_inv: int) -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Limpa e cria as colunas no formato desejado.\n",
    "    \"\"\"\n",
    "\n",
    "    # normaliza nomes de colunas\n",
    "    norm_map = {}\n",
    "    for col in df.columns:\n",
    "        norm = (\n",
    "            str(col)\n",
    "            .strip()\n",
    "            .lower()\n",
    "            .replace(\"\\n\", \" \")\n",
    "        )\n",
    "        norm_map[col] = norm\n",
    "\n",
    "    rename_map = {\n",
    "        \"bloco\": \"bloco\",\n",
    "        \"naves\": \"naves\",\n",
    "        \"n¬∫ naves\": \"n_naves\",\n",
    "        \"no naves\": \"n_naves\",\n",
    "        \"n naves\": \"n_naves\",\n",
    "        \"√°rea/nave\": \"area_nave\",\n",
    "        \"area/nave\": \"area_nave\",\n",
    "        \"√°rea total\": \"area_total\",\n",
    "        \"area total\": \"area_total\",\n",
    "        \"cultura\": \"cultura\",\n",
    "        \"idade\": \"idade\",\n",
    "        \"semana do plantio\": \"semana_plantio\",\n",
    "        \"data do plantio\": \"data_plantio\",\n",
    "    }\n",
    "\n",
    "    # aplica rename baseado no nome normalizado\n",
    "    rename_dict = {}\n",
    "    for original, norm in norm_map.items():\n",
    "        if norm in rename_map:\n",
    "            rename_dict[original] = rename_map[norm]\n",
    "\n",
    "    df = df.rename(columns=rename_dict)\n",
    "\n",
    "    # mant√©m s√≥ as colunas de interesse, se existirem\n",
    "    cols_interesse = [\n",
    "        \"bloco\",\n",
    "        \"naves\",\n",
    "        \"n_naves\",\n",
    "        \"area_nave\",\n",
    "        \"area_total\",\n",
    "        \"cultura\",\n",
    "        \"idade\",\n",
    "        \"semana_plantio\",\n",
    "        \"data_plantio\",\n",
    "    ]\n",
    "    df = df[[c for c in cols_interesse if c in df.columns]].copy()\n",
    "\n",
    "    # üî• FILTRO EXTRA: dropar linhas sem Naves (elimina as tabelas de cultura)\n",
    "    if \"naves\" in df.columns:\n",
    "        df[\"naves\"] = df[\"naves\"].astype(str).str.strip()\n",
    "        df = df[df[\"naves\"] != \"\"]\n",
    "        df = df[~df[\"naves\"].isna()]\n",
    "\n",
    "    # bloco -> inteiro\n",
    "    df[\"bloco\"] = pd.to_numeric(df[\"bloco\"], errors=\"coerce\")\n",
    "    df = df.dropna(subset=[\"bloco\"])\n",
    "    df[\"bloco\"] = df[\"bloco\"].astype(int)\n",
    "\n",
    "    # \"Bloco 1\", \"Bloco 2\", ...\n",
    "    df[\"bloco_modelado\"] = \"Bloco \" + df[\"bloco\"].astype(str)\n",
    "\n",
    "    # n¬∫ naves\n",
    "    if \"n_naves\" in df.columns:\n",
    "        df[\"n_naves\"] = pd.to_numeric(df[\"n_naves\"], errors=\"coerce\")\n",
    "\n",
    "    # √Årea/Nave e √Årea Total\n",
    "    for col in [\"area_nave\", \"area_total\"]:\n",
    "        if col in df.columns:\n",
    "            df[col] = (\n",
    "                df[col].astype(str)\n",
    "                .str.replace(\".\", \"\", regex=False)\n",
    "                .str.replace(\",\", \".\", regex=False)\n",
    "            )\n",
    "            df[col] = pd.to_numeric(df[col], errors=\"coerce\")\n",
    "\n",
    "    # idade e semana do plantio\n",
    "    for col in [\"idade\", \"semana_plantio\"]:\n",
    "        if col in df.columns:\n",
    "            df[col] = pd.to_numeric(df[col], errors=\"coerce\")\n",
    "\n",
    "    # data do plantio\n",
    "    if \"data_plantio\" in df.columns:\n",
    "        df[\"data_plantio_str\"] = df[\"data_plantio\"].astype(str)\n",
    "        df[\"data_plantio\"] = pd.to_datetime(\n",
    "            df[\"data_plantio_str\"].str.extract(r\"(\\d{2}/\\d{2}/\\d{4})\", expand=False),\n",
    "            format=\"%d/%m/%Y\",\n",
    "            errors=\"coerce\",\n",
    "        )\n",
    "\n",
    "    # ano e semana do invent√°rio\n",
    "    df[\"ano\"] = ano\n",
    "    df[\"semana_inventario\"] = semana_inv\n",
    "\n",
    "    # ordena colunas\n",
    "    col_order = [\n",
    "        \"bloco_modelado\",\n",
    "        \"bloco\",\n",
    "        \"naves\",\n",
    "        \"n_naves\",\n",
    "        \"area_nave\",\n",
    "        \"area_total\",\n",
    "        \"cultura\",\n",
    "        \"idade\",\n",
    "        \"semana_plantio\",\n",
    "        \"data_plantio\",\n",
    "        \"ano\",\n",
    "        \"semana_inventario\",\n",
    "    ]\n",
    "    df = df[[c for c in col_order if c in df.columns]]\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def processar_inventario_pdf(file_path: str) -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Processa UM PDF:\n",
    "      - extrai ano/semana do nome\n",
    "      - encontra a tabela com '√Årea Total'\n",
    "      - limpa e modela as colunas\n",
    "    \"\"\"\n",
    "    ano, semana_inv = extract_year_week_from_filename(file_path)\n",
    "    if ano is None:\n",
    "        print(f\"‚ö† N√£o consegui extrair ano/semana de {file_path}\")\n",
    "        return pd.DataFrame()\n",
    "\n",
    "    base = ler_tabela_estufas(file_path)\n",
    "    if base.empty:\n",
    "        return pd.DataFrame()\n",
    "\n",
    "    df = limpar_e_transformar(base, ano, semana_inv)\n",
    "    df[\"arquivo_origem\"] = Path(file_path).name\n",
    "    return df\n",
    "\n",
    "\n",
    "def processar_pasta_inventario(dir_path: str) -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Varre TODOS os PDFs da pasta e concatena num √∫nico DataFrame.\n",
    "    Depois remove linhas sem Naves (para eliminar tabelas de cultura).\n",
    "    \"\"\"\n",
    "    pasta = Path(dir_path)\n",
    "    pdfs = list(pasta.glob(\"*.pdf\"))\n",
    "\n",
    "    print(f\"Encontrados {len(pdfs)} PDFs na pasta {pasta}.\")\n",
    "\n",
    "    dfs = []\n",
    "    for pdf in pdfs:\n",
    "        print(f\"Processando: {pdf.name}\")\n",
    "        df_tmp = processar_inventario_pdf(str(pdf))\n",
    "        if not df_tmp.empty:\n",
    "            dfs.append(df_tmp)\n",
    "\n",
    "    if not dfs:\n",
    "        print(\"‚ö† Nenhum dado processado.\")\n",
    "        return pd.DataFrame()\n",
    "\n",
    "    df_final = pd.concat(dfs, ignore_index=True)\n",
    "\n",
    "    # üî• LIMPEZA FINAL: remover linhas sem Naves\n",
    "    if \"naves\" in df_final.columns:\n",
    "        df_final[\"naves\"] = df_final[\"naves\"].astype(str).str.strip()\n",
    "        df_final = df_final[\n",
    "            (df_final[\"naves\"].notna()) &\n",
    "            (df_final[\"naves\"] != \"\") &\n",
    "            (df_final[\"naves\"].str.lower() != \"none\")\n",
    "        ]\n",
    "\n",
    "    print(\"‚úî Processamento conclu√≠do ap√≥s limpeza final.\")\n",
    "    return df_final"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "3e02660e",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Conex√£o criada com sucesso: postgresql://estufas_user:estufas_pass_123@localhost:5432/estufas_kibala\n"
     ]
    }
   ],
   "source": [
    "# Carrega vari√°veis do .env na raiz do projeto\n",
    "load_dotenv()\n",
    "\n",
    "# Tenta pegar a DATABASE_URL do .env.\n",
    "# Exemplo no .env:\n",
    "# DATABASE_URL=postgresql://estufas_user:estufas_pass_123@localhost:5432/estufas_kibala\n",
    "DATABASE_URL = os.getenv(\n",
    "    \"DATABASE_URL\",\n",
    "    \"postgresql://estufas_user:estufas_pass_123@localhost:5432/estufas_kibala\"\n",
    ")\n",
    "\n",
    "engine = create_engine(DATABASE_URL)\n",
    "\n",
    "# (Opcional, mas recomendado) garantir que o schema bronze exista\n",
    "with engine.begin() as conn:\n",
    "    conn.execute(text(\"CREATE SCHEMA IF NOT EXISTS bronze;\"))\n",
    "\n",
    "print(\"Conex√£o criada com sucesso:\", DATABASE_URL)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "23090898",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Encontrados 3 PDFs na pasta C:\\Users\\cauai.Capozzoli\\Desktop\\DB\\estufas\\inventario.\n",
      "Processando: ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf\n",
      "Processando: ES2549 InventaÃÅrio Estufas - Semana 49 2025.pdf\n",
      "Processando: ES2550 InventaÃÅrio Estufas - Semana 50 2025.pdf\n",
      "‚úî Processamento conclu√≠do ap√≥s limpeza final.\n",
      "Shape do DataFrame final: (99, 13)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>bloco_modelado</th>\n",
       "      <th>bloco</th>\n",
       "      <th>naves</th>\n",
       "      <th>n_naves</th>\n",
       "      <th>area_nave</th>\n",
       "      <th>area_total</th>\n",
       "      <th>cultura</th>\n",
       "      <th>idade</th>\n",
       "      <th>semana_plantio</th>\n",
       "      <th>data_plantio</th>\n",
       "      <th>ano</th>\n",
       "      <th>semana_inventario</th>\n",
       "      <th>arquivo_origem</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Bloco 1</td>\n",
       "      <td>1</td>\n",
       "      <td>1 a 23</td>\n",
       "      <td>14.0</td>\n",
       "      <td>0.057</td>\n",
       "      <td>0.798</td>\n",
       "      <td>Flores</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>2025</td>\n",
       "      <td>48</td>\n",
       "      <td>ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Bloco 2</td>\n",
       "      <td>2</td>\n",
       "      <td>1 a 19</td>\n",
       "      <td>19.0</td>\n",
       "      <td>0.057</td>\n",
       "      <td>1.083</td>\n",
       "      <td>Flores</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>2025</td>\n",
       "      <td>48</td>\n",
       "      <td>ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Bloco 3</td>\n",
       "      <td>3</td>\n",
       "      <td>1 a 19</td>\n",
       "      <td>19.0</td>\n",
       "      <td>0.057</td>\n",
       "      <td>1.083</td>\n",
       "      <td>Opera√ß√µes Campo Aberto e Caf√©</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>2025</td>\n",
       "      <td>48</td>\n",
       "      <td>ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Bloco 4</td>\n",
       "      <td>4</td>\n",
       "      <td>1 a 8</td>\n",
       "      <td>8.0</td>\n",
       "      <td>0.057</td>\n",
       "      <td>0.456</td>\n",
       "      <td>Em limpeza.</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>2025</td>\n",
       "      <td>48</td>\n",
       "      <td>ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Bloco 4</td>\n",
       "      <td>4</td>\n",
       "      <td>10 a 17</td>\n",
       "      <td>8.0</td>\n",
       "      <td>0.057</td>\n",
       "      <td>0.456</td>\n",
       "      <td>Opera√ß√µes Campo Aberto e Caf√©</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>2025</td>\n",
       "      <td>48</td>\n",
       "      <td>ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  bloco_modelado  bloco    naves  n_naves  area_nave  area_total  \\\n",
       "0        Bloco 1      1   1 a 23     14.0      0.057       0.798   \n",
       "1        Bloco 2      2   1 a 19     19.0      0.057       1.083   \n",
       "2        Bloco 3      3   1 a 19     19.0      0.057       1.083   \n",
       "3        Bloco 4      4    1 a 8      8.0      0.057       0.456   \n",
       "4        Bloco 4      4  10 a 17      8.0      0.057       0.456   \n",
       "\n",
       "                         cultura  idade  semana_plantio data_plantio   ano  \\\n",
       "0                         Flores    NaN             NaN          NaT  2025   \n",
       "1                         Flores    NaN             NaN          NaT  2025   \n",
       "2  Opera√ß√µes Campo Aberto e Caf√©    NaN             NaN          NaT  2025   \n",
       "3                    Em limpeza.    NaN             NaN          NaT  2025   \n",
       "4  Opera√ß√µes Campo Aberto e Caf√©    NaN             NaN          NaT  2025   \n",
       "\n",
       "   semana_inventario                                   arquivo_origem  \n",
       "0                 48  ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf  \n",
       "1                 48  ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf  \n",
       "2                 48  ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf  \n",
       "3                 48  ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf  \n",
       "4                 48  ES2548 InventaÃÅrio Estufas - Semana 48 2025.pdf  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Tabela bronze.inventario_estufas_bronze carregada com sucesso no Postgres! ‚úÖ\n"
     ]
    }
   ],
   "source": [
    "# 1) Processa todos os PDFs/arquivos da pasta de invent√°rio\n",
    "df_final = processar_pasta_inventario(\n",
    "    r\"C:\\Users\\cauai.Capozzoli\\Desktop\\DB\\estufas\\inventario\"\n",
    ")\n",
    "\n",
    "print(\"Shape do DataFrame final:\", df_final.shape)\n",
    "display(df_final.head())\n",
    "\n",
    "# 2) Opcional: normalizar nomes de colunas (sem espa√ßos, min√∫sculo, etc.)\n",
    "df_bronze = df_final.copy()\n",
    "df_bronze.columns = (\n",
    "    df_bronze.columns\n",
    "    .str.strip()\n",
    "    .str.lower()\n",
    "    .str.normalize(\"NFKD\")\n",
    "    .str.replace(\" \", \"_\")\n",
    "    .str.replace(r\"[^a-z0-9_]\", \"\", regex=True)\n",
    ")\n",
    "\n",
    "# 3) Gravar na camada bronze do Postgres\n",
    "tabela_bronze = \"inventario_estufas_bronze\"\n",
    "\n",
    "df_bronze.to_sql(\n",
    "    name=tabela_bronze,\n",
    "    con=engine,\n",
    "    schema=\"bronze\",   # vai cair em bronze.inventario_estufas\n",
    "    if_exists=\"replace\",  # ou \"append\" quando for carga incremental\n",
    "    index=False\n",
    ")\n",
    "\n",
    "print(f\"Tabela bronze.{tabela_bronze} carregada com sucesso no Postgres! ‚úÖ\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
